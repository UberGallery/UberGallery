<?php

namespace App\Factories;

use App\Config;
use Invoker\CallableResolver;
use Slim\Views\Twig;
use Twig\Extension\CoreExtension;
use Twig\Loader\FilesystemLoader;
use Twig\TwigFunction;

class TwigFactory
{
    protected Config $config;
    protected CallableResolver $callableResolver;

    /** Create a new TwigFactory object. */
    public function __construct(
        Config $config,
        CallableResolver $callableResolver
    ) {
        $this->config = $config;
        $this->callableResolver = $callableResolver;
    }

    /** Initialize and return the Twig component. */
    public function __invoke(): Twig
    {
        $twig = new Twig(new FilesystemLoader(
            $this->config->get('views_path')
        ), ['cache' => $this->config->get('view_cache')]);

        $environment = $twig->getEnvironment();

        /** @var CoreExtension $core */
        $core = $environment->getExtension(CoreExtension::class);
        $core->setDateFormat($this->config->get('date_format'), '%d days');
        $core->setTimezone($this->config->get('timezone'));

        foreach ($this->config->get('view_functions') as $function) {
            $function = $this->callableResolver->resolve($function);

            $environment->addFunction(
                new TwigFunction($function->name(), $function)
            );
        }

        return $twig;
    }
}
